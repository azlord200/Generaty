<!DOCTYPE html>
<html lang="fr" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Générateur de fichiers – taille au choix</title>
  <style>
    :root{
      --bg: #f7f7f9;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --primary: #2563eb;
      --primary-contrast: #ffffff;
      --border: #e5e7eb;
      --accent: #22c55e;
      --warn: #b45309;
      --warn-bg: #fff7ed;
      --danger: #dc2626;
    }
    [data-theme="dark"]{
      --bg: #0b1220;
      --card: #0f172a;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --primary: #60a5fa;
      --primary-contrast: #0b1220;
      --border: #1f2937;
      --accent: #22c55e;
      --warn: #f59e0b;
      --warn-bg: #452a03;
      --danger: #f87171;
    }

    html, body {height: 100%;}
    body{
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    .container{
      max-width: 880px;
      margin: 0 auto;
      padding: 24px 16px 64px;
      display: grid;
      gap: 16px;
    }
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    h1{font-size: clamp(1.4rem, 3vw, 2rem);margin:0;}
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 20px rgba(0,0,0,.05);
    }
    .row{
      display: grid;
      grid-template-columns: 1fr 1fr;
      /* Increase the horizontal gap between columns for better spacing */
      column-gap: 24px;
      row-gap: 12px;
    }
    .row-3{
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      /* Increase the horizontal gap between columns for better spacing */
      column-gap: 24px;
      row-gap: 12px;
    }

    /* Ensure grid items can shrink properly and add internal right padding to
       all but the last cell to visually separate adjacent input fields. Without
       this padding, the borders of inputs can appear to merge together. */
    .row > div,
    .row-3 > div {
      min-width: 0;
    }
    .row > div:not(:last-child),
    .row-3 > div:not(:last-child) {
      padding-right: 24px;
    }
    @media (max-width: 720px){
      .row,.row-3{grid-template-columns:1fr;}
    }
    label{font-weight:600; font-size:.95rem}
    .help{color:var(--muted); font-size:.9rem}
    input[type="number"], input[type="text"], select{
      width: 100%;
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 1rem;
      outline: none;
    }
    .btns{display:flex;gap:12px;flex-wrap:wrap}
    button{
      appearance: none;
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform .05s ease, opacity .2s ease, background .2s ease;
    }
    button:active{transform: translateY(1px)}
    .btn-primary{background: var(--primary); color: var(--primary-contrast);} 
    .btn-secondary{background: transparent; color: var(--text); border: 1px solid var(--border);} 
    .btn-danger{background: var(--danger); color: #fff;}

    /* Icon buttons for external links (Discord & GitHub). These share similar
       styling to our secondary buttons but include an inline SVG icon and
       custom spacing. */
    .icon-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      font-weight: 600;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: transparent;
      color: var(--text);
      text-decoration: none;
      cursor: pointer;
      transition: background .15s ease;
    }
    .icon-btn:hover {
      background: rgba(0,0,0,0.05);
    }

    .progress-outer{background: transparent;border:1px solid var(--border);border-radius: 999px;height: 16px;position: relative;overflow:hidden}
    .progress-inner{background: var(--primary);height:100%;width:0%;transition: width .15s linear}
    .progress-text{font-variant-numeric: tabular-nums}

    .notice{border:1px dashed var(--warn);background: var(--warn-bg);color: var(--text);padding:12px;border-radius:12px;display:none}
    .notice strong{color:var(--warn)}
    .muted{color:var(--muted)}
    .status{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:.9rem}
    .pill.ok{border-color: var(--accent)}
    .pill.warn{border-color: var(--warn)}

    /* Transitions douces + tamisation lors du switch de thème */
    *{transition: background-color .25s ease, color .25s ease, border-color .25s ease}
    .scrim{position:fixed;inset:0;background:#000;opacity:0;pointer-events:none;transition:opacity .28s ease}
    body.dim .scrim{opacity:.35}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Générateur de fichiers</h1>
      <button id="themeBtn" class="btn-secondary" aria-pressed="false" title="Basculer le thème">☀️</button>
    </header>

    <section class="card" aria-labelledby="controls-title">
      <h2 id="controls-title" style="margin-top:0">Paramètres</h2>
      <div class="row-3" style="margin-top:12px">
        <div>
          <label for="filename">Nom du fichier</label>
          <input id="filename" type="text" placeholder="fichier.bin" value="fichier.bin" />
          <p class="help">Le contenu est rempli d'octets nuls.</p>
        </div>
        <div>
          <label for="size">Taille</label>
          <input id="size" type="number" min="1" step="1" value="10" />
          <p class="help">Nombre entier &ge; 1</p>
        </div>
        <div>
          <label for="unit">Unité</label>
          <select id="unit">
            <option value="ko">Ko</option>
            <option value="mo" selected>Mo</option>
            <option value="go">Go</option>
          </select>
          <p class="help">Calcul en base 1024 (KiB/MiB/GiB).</p>
        </div>
      </div>

      <div class="btns" style="margin-top:16px">
        <button id="start" class="btn-primary">Générer</button>
        <button id="cancel" class="btn-danger" disabled>Annuler</button>
        <button id="reset" class="btn-secondary">Réinitialiser</button>
      </div>

      <div id="ff-warning" class="notice" role="alert" style="margin-top:12px">
        <strong>Avertissement mémoire (Firefox)</strong><br>
        Ce navigateur est basé sur Firefox. La génération sans accès direct au disque nécessite de créer le fichier en mémoire, ce qui peut entraîner une forte consommation de RAM et des plantages au‑delà de ~200 Mo. Préférez des tailles modestes, ou utilisez un navigateur compatible avec l'écriture directe sur disque (Chromium/Edge) pour des gros fichiers.
      </div>

      <div id="fallback-warning" class="notice" role="status" style="margin-top:12px">
        <strong>Mode compatibilité</strong><br>
        L'écriture directe sur disque n'est pas disponible. Le fichier sera d'abord construit en mémoire puis proposé au téléchargement.
      </div>

      <div class="status" style="margin-top:16px">
        <div class="pill" id="capability-pill">Vérification des capacités…</div>
        <div class="muted">Progression : <span class="progress-text" id="pct">0%</span></div>
      </div>
      <div class="progress-outer" aria-label="Progression de la génération" style="margin-top:8px">
        <div class="progress-inner" id="bar"></div>
      </div>
      <p class="help" id="status">Prêt.</p>
      <!-- External links to Discord server and GitHub profile -->
      <div class="external-links" style="margin-top:16px;display:flex;gap:16px;flex-wrap:wrap">
        <a href="https://discord.gg/sqkbjB24q7" class="icon-btn" target="_blank" rel="noopener noreferrer">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
            <path d="M13.545 2.907a13.2 13.2 0 0 0-3.257-1.011.05.05 0 0 0-.052.025c-.141.25-.297.577-.406.833a12.2 12.2 0 0 0-3.658 0 8 8 0 0 0-.412-.833.05.05 0 0 0-.052-.025c-1.125.194-2.22.534-3.257 1.011a.04.04 0 0 0-.021.018C.356 6.024-.213 9.047.066 12.032q.003.022.021.037a13.3 13.3 0 0 0 3.995 2.02.05.05 0 0 0 .056-.019q.463-.63.818-1.329a.05.05 0 0 0-.01-.059l-.018-.011a9 9 0 0 1-1.248-.595.05.05 0 0 1-.02-.066l.015-.019q.127-.095.248-.195a.05.05 0 0 1 .051-.007c2.619 1.196 5.454 1.196 8.041 0a.05.05 0 0 1 .053.007q.121.1.248.195a.05.05 0 0 1-.004.085 8 8 0 0 1-1.249.594.05.05 0 0 0-.03.03.05.05 0 0 0 .003.041c.24.465.515.909.817 1.329a.05.05 0 0 0 .056.019 13.2 13.2 0 0 0 4.001-2.02.05.05 0 0 0 .021-.037c.334-3.451-.559-6.449-2.366-9.106a.03.03 0 0 0-.02-.019m-8.198 7.307c-.789 0-1.438-.724-1.438-1.612s.637-1.613 1.438-1.613c.807 0 1.45.73 1.438 1.613 0 .888-.637 1.612-1.438 1.612m5.316 0c-.788 0-1.438-.724-1.438-1.612s.637-1.613 1.438-1.613c.807 0 1.451.73 1.438 1.613 0 .888-.631 1.612-1.438 1.612"/>
          </svg>
          <span>Serveur&nbsp;Discord</span>
        </a>
        <a href="https://github.com/azlord200" class="icon-btn" target="_blank" rel="noopener noreferrer">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8"/>
          </svg>
          <span>GitHub</span>
        </a>
      </div>
    </section>
  </div>

  <div class="scrim" aria-hidden="true"></div>

  <script>
    // --- Thème (icône soleil/lune) + effet de tamisation ---
    const themeBtn = document.getElementById('themeBtn');
    const root = document.documentElement;
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

    function applyTheme(mode){
      const m = mode === 'dark' ? 'dark' : 'light';
      root.setAttribute('data-theme', m);
      const isDark = m === 'dark';
      themeBtn.setAttribute('aria-pressed', String(isDark));
      themeBtn.textContent = isDark ? '🌙' : '☀️';
    }
    function flashDim(){
      document.body.classList.add('dim');
      setTimeout(()=>{ document.body.classList.remove('dim'); }, 260);
    }
    applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
    themeBtn.addEventListener('click', () => {
      flashDim();
      const current = root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
      const next = current === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', next);
      applyTheme(next);
    });

    // --- DOM refs ---
    const sizeEl = document.getElementById('size');
    const unitEl = document.getElementById('unit');
    const filenameEl = document.getElementById('filename');
    const startBtn = document.getElementById('start');
    const cancelBtn = document.getElementById('cancel');
    const resetBtn = document.getElementById('reset');

    const bar = document.getElementById('bar');
    const pct = document.getElementById('pct');
    const statusEl = document.getElementById('status');
    const ffWarning = document.getElementById('ff-warning');
    const fallbackWarning = document.getElementById('fallback-warning');
    const capabilityPill = document.getElementById('capability-pill');

    // --- Détection du navigateur & capacités ---
    const isFirefox = typeof InstallTrigger !== 'undefined' || /firefox/i.test(navigator.userAgent);
    const canStreamToDisk = 'showSaveFilePicker' in window && typeof window.showSaveFilePicker === 'function';

    if(isFirefox){ ffWarning.style.display = 'block'; }

    if(canStreamToDisk){
      capabilityPill.textContent = 'Écriture directe sur disque disponible';
      capabilityPill.classList.add('ok','pill');
      fallbackWarning.style.display = 'none';
    }else{
      capabilityPill.textContent = 'Mode compatibilité (mémoire)';
      capabilityPill.classList.add('warn','pill');
      fallbackWarning.style.display = 'block';
    }

    // --- Outils UI ---
    function setProgress(ratio){
      const clamped = Math.max(0, Math.min(1, ratio || 0));
      bar.style.width = (clamped*100).toFixed(2) + '%';
      pct.textContent = (clamped*100).toFixed(1) + '%';
    }
    function setStatus(text){ statusEl.textContent = text; }
    function enableControls(enabled){
      startBtn.disabled = !enabled;
      cancelBtn.disabled = enabled;
      sizeEl.disabled = !enabled;
      unitEl.disabled = !enabled;
      filenameEl.disabled = !enabled;
    }

    function unitToFactor(u){
      switch((u||'').toLowerCase()){
        case 'ko': return 1024;           // KiB
        case 'mo': return 1024*1024;      // MiB
        case 'go': return 1024*1024*1024; // GiB
        default: return 1;
      }
    }

    function bytesFromInput(){
      const n = Math.max(1, Math.floor(Number(sizeEl.value || '0')));
      const factor = unitToFactor(unitEl.value);
      const total = BigInt(n) * BigInt(factor);
      const MAX_MEM_BYTES = 200n * 1024n * 1024n;
      if(!canStreamToDisk && total > MAX_MEM_BYTES){
        throw new Error('La taille demandée dépasse la limite prudente en mode mémoire (~200 Mo). Réduisez la taille ou utilisez un navigateur compatible avec l\'écriture directe sur disque.');
      }
      return Number(total);
    }

    let abortFlag = false;

    function makeZeroChunk(size){ return new Uint8Array(size); }

    async function sleepFrame(){
      return new Promise(r => setTimeout(r, 0));
    }

    async function generateStreamingToDisk(totalBytes, fileName, chunkSize){
      const handle = await window.showSaveFilePicker({
        suggestedName: fileName || 'fichier.bin',
        types: [{ description: 'Binaire', accept: { 'application/octet-stream': ['.bin'] } }]
      });
      const stream = await handle.createWritable();

      let written = 0;
      const chunk = makeZeroChunk(chunkSize);

      try {
        while(written < totalBytes){
          if(abortFlag){ throw new Error('Annulé par l\'utilisateur'); }
          const remaining = totalBytes - written;
          const toWrite = remaining >= chunkSize ? chunk : chunk.subarray(0, remaining);
          await stream.write(toWrite);
          written += toWrite.length;
          setProgress(written / totalBytes);
          if((written & ((1<<22)-1)) === 0){ await sleepFrame(); }
        }
        await stream.close();
        setProgress(1);
        setStatus('Terminé : fichier écrit directement sur disque.');
      } catch (err){
        try { if(stream && stream.abort) await stream.abort(); } catch(_){}}
    }

    async function generateInMemory(totalBytes, fileName, chunkSize){
      const parts = [];
      let added = 0;
      const chunk = makeZeroChunk(chunkSize);

      while(added < totalBytes){
        if(abortFlag){ throw new Error('Annulé par l\'utilisateur'); }
        const remaining = totalBytes - added;
        const piece = remaining >= chunkSize ? chunk : chunk.subarray(0, remaining);
        parts.push(piece);
        added += piece.length;
        setProgress(added / totalBytes);
        if((added & ((1<<22)-1)) === 0){ await sleepFrame(); }
      }
      const blob = new Blob(parts, { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName || 'fichier.bin';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setStatus('Terminé : fichier prêt au téléchargement.');
      setProgress(1);
      setTimeout(() => URL.revokeObjectURL(url), 5000);
    }

    async function startGeneration(){
      abortFlag = false;
      setProgress(0); setStatus('Préparation…');
      enableControls(false);
      try{
        const totalBytes = bytesFromInput();
        const name = (filenameEl.value || 'fichier.bin').trim();
        const chunkSize = Math.max(64*1024, 1048576); // 1 MiB

        const pretty = new Intl.NumberFormat('fr-FR').format(totalBytes);
        setStatus(`Génération de ${pretty} octets…`);

        if(canStreamToDisk){
          await generateStreamingToDisk(totalBytes, name, chunkSize);
        } else {
          await generateInMemory(totalBytes, name, chunkSize);
        }
      } catch(err){
        console.error(err);
        setStatus('Erreur : ' + (err.message || err));
      } finally {
        enableControls(true);
      }
    }

    // Brancher les boutons
    startBtn.addEventListener('click', startGeneration);
    cancelBtn.addEventListener('click', () => { abortFlag = true; setStatus('Annulation en cours…'); });
    resetBtn.addEventListener('click', () => {
      abortFlag = true;
      setProgress(0);
      setStatus('Prêt.');
      sizeEl.value = 10; unitEl.value = 'mo'; filenameEl.value = 'fichier.bin';
    });

  </script>
</body>
</html>
